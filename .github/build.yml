name: Build and Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Build with Maven
      run: mvn clean install

    - name: Get short commit SHA
      id: commit_sha
      run: echo "::set-output name=sha::$(git rev-parse --short HEAD)"

    - name: Bump version and tag
      run: |
        # Odczytaj bieżący numer wersji
        CURRENT_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
        
        # Ustaw numer wersji na krótki SHA commita
        NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. -v OFS=. '{print $1 "." $2 "." ENVIRON["commit_sha"]}')
        
        # Aktualizuj numer wersji w pliku pom.xml
        mvn versions:set -DnewVersion=$NEW_VERSION
        
        # Zacommituj zmiany
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        git add pom.xml
        git commit -m "Bump version to $NEW_VERSION [skip ci]"

        # Zataguj nową wersję
        git tag -a $NEW_VERSION -m "Release version $NEW_VERSION [skip ci]"

        # Wypchnij zmiany i tag na gałąź główną
        git push origin main
        git push origin $NEW_VERSION
